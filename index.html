<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quantum Truth MUD — The Canonical Library</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="stylesheet" href="./css/styles.css"/>
  <meta name="theme-color" content="#0a0e27">
</head>
<body>
  <!-- Setup Screen -->
  <div id="setup-screen" class="setup-screen">
    <div class="setup-container">
      <h1 class="mirror-text">The Canonical Library</h1>
      <p style="text-align:center; margin:12px 0 16px; line-height:1.6;">A Quantum Truth MUD powered by AI</p>

      <div class="row" style="margin:14px 0 4px; justify-content:space-between;">
        <div style="flex:1;">
          <label style="display:block; margin-bottom:8px;">OpenAI API Key (BYOK):</label>
          <input type="password" id="api-key-input" class="api-input" placeholder="sk-..." value=""/>
          <p class="tiny">Stored locally and sent only to OpenAI. For production, proxy on your server.</p>
        </div>
      </div>

      <div class="row" style="gap:12px;">
        <div style="flex:2;">
          <label style="display:block; margin:10px 0 6px;">Text Model</label>
          <select id="text-model" class="select-input">
            <option value="gpt-4o-mini" selected>gpt-4o-mini (default)</option>
            <option value="gpt-4o">gpt-4o</option>
            <option value="gpt-5">gpt-5 (if enabled)</option>
          </select>
        </div>
        <div style="flex:2;">
          <label style="display:block; margin:10px 0 6px;">Image Model</label>
          <select id="image-model" class="select-input">
            <option value="gpt-image-1" selected>gpt-image-1</option>
          </select>
        </div>
      </div>

      <button class="setup-button" onclick="game.validateAndStart()">Enter the Library</button>
      <button class="setup-button secondary" onclick="game.startOffline()">Play Offline (No AI/Images)</button>

      <p style="text-align:center; margin-top:14px;" class="tiny">
        Get your API key:
        <a href="https://platform.openai.com/api-keys" target="_blank" style="color:var(--brand);">OpenAI Platform</a>
      </p>
    </div>
  </div>

  <!-- Status Panel -->
  <div id="status-panel" class="status-panel">
    <div class="status-item"><span><span class="status-dot inactive" id="ai-status"></span>AI</span><span id="ai-status-text">Offline</span></div>
    <div class="status-item"><span><span class="status-dot inactive" id="image-status"></span>Images</span><span id="image-status-text">Offline</span></div>
    <div class="status-item"><span>Tokens</span><span id="token-count">0</span></div>
    <div class="status-item"><button class="setup-button secondary" style="padding:8px 10px; font-size:.9em;" onclick="game.resetGameConfirm()">Reset</button></div>
  </div>

  <!-- Main Game Container -->
  <div id="game-container">
    <!-- Covenant Screen -->
    <div id="covenant" class="covenant-screen">
      <h1 class="mirror-text">The Mirror Covenant</h1>
      <h2>⚠️ Essential Understanding</h2>
      <ul style="margin:14px 0; line-height:1.7;">
        <li>Your character reflects your choices.</li>
        <li>The Quantum Librarian observes and adapts.</li>
        <li>Each room is unique to your state.</li>
        <li>Your path is yours alone.</li>
      </ul>
      <p style="margin: 16px 0; font-style: italic; text-align:center;">“We don't see things as they are, we see them as we are.” — Anaïs Nin</p>
      <div style="text-align:center;">
        <button class="choice-btn" onclick="game.acceptCovenant()">I Accept the Mirror's Truth</button>
      </div>
    </div>

    <!-- Character Creation -->
    <div id="creation" class="creation-screen">
      <div class="scene-container">
        <div id="creation-text" class="scene-text"></div>
        <div id="creation-choices" class="choices"></div>
      </div>
    </div>

    <!-- Main Game -->
    <div id="game" class="game-screen">
      <div id="image-display">
        <img id="room-image" class="room-image" src="" alt=""/>
        <div class="image-loading hidden" id="image-loading">
          <div class="quantum-spinner"></div>
          <p>Generating quantum reality…</p>
        </div>
        <div class="quantum-overlay"></div>
      </div>
      <div id="text-output"></div>
      <input
        type="text"
        id="command-input"
        placeholder="What do you do? (try: help)"
        onkeypress="if(event.key==='Enter') game.processCommand()"
      />
    </div>

    <!-- Character Display -->
    <div id="character" class="character-display" style="display:none;">
      <div style="text-align:center; font-weight:bold; color:#64c8ff; margin-bottom:8px;"><span id="char-name">Unknown</span></div>
      <div style="font-size:.95em;">
        <div>Truth: <span id="truth-density">50%</span></div>
        <div class="stat-bar"><div class="stat-fill" id="truth-bar" style="width:50%"></div></div>
        <div>Quantum: <span id="quantum-coherence">0%</span></div>
        <div class="stat-bar"><div class="stat-fill" id="quantum-bar" style="width:0%"></div></div>
        <div>Shadow: <span id="shadow-integration">0%</span></div>
        <div class="stat-bar"><div class="stat-fill" id="shadow-bar" style="width:0%"></div></div>
        <div style="margin-top:10px; padding-top:10px; border-top:1px solid var(--brand);">
          <div>Stage: <span id="hero-stage" style="color:#aaf;">Threshold</span></div>
          <div>Actions: <span id="action-count" style="color:#aaf;">0</span></div>
        </div>
      </div>
    </div>

    <!-- Map Display -->
    <div id="map" class="map-display">
      <div style="color:#99a; font-size:.8em; margin-bottom:6px;">Known Paths (click to travel):</div>
      <div id="map-grid"></div>
    </div>

    <!-- Cache Info -->
    <div class="cache-info">
      <div>Images Cached: <span id="cache-count">0</span></div>
      <div>Cache Size: <span id="cache-size">0 KB</span></div>
      <div style="margin-top:6px; display:flex; gap:6px;">
        <button class="setup-button secondary" style="padding:6px 8px; font-size:.85em;" onclick="game.exportSave()">Export</button>
        <label class="setup-button secondary" style="padding:6px 8px; font-size:.85em; cursor:pointer;">
          Import <input type="file" id="import-file" accept="application/json" style="display:none;" onchange="game.importSave(this.files[0])"/>
        </label>
      </div>
    </div>
  </div>

  <script type="module" src="./js/app.js"></script>
</body>
</html>
